# docker-compose.prod.yml

services:
  db:
    image: postgres:16-alpine
    container_name: demoecommerce-db-prod
    environment:
      POSTGRES_DB: demoecommerce
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: secret
    volumes:
      - db-data-prod:/var/lib/postgresql/data
    # En un entorno real, normalmente NO expones el puerto hacia afuera
    # ports:
    #   - "5432:5432"

  backend:
    build:
      context: ./backend
      target: prod          # ðŸŸ¢ usamos la etapa prod
    container_name: demoecommerce-backend-prod
    working_dir: /var/www
    env_file:
      - ./backend/.env
    depends_on:
      - db

  nginx-api:
    image: nginx:1.27-alpine
    container_name: demoecommerce-nginx-api-prod
    ports:
      - "8080:80"           # API prod-like en http://localhost:8080
    volumes:
      - ./docker/nginx/nginx.api.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend

  frontend:
    build:
      context: ./frontend
      target: prod          # ðŸŸ¢ Nginx sirviendo el build de React
    container_name: demoecommerce-frontend-prod
    ports:
      - "8081:80"           # Frontend estÃ¡tico en http://localhost:8081
    depends_on:
      - nginx-api

volumes:
  db-data-prod:
